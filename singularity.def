# Singularity Container for CPI Detection

# Build this container on your local machine, then transfer to HPC
# Singularity containers are portable and work on most HPC systems

Bootstrap: docker
From: pytorch/pytorch:1.6.0-cuda10.1-cudnn7-devel

%post
    # Install system dependencies
    apt-get update && apt-get install -y \
        git \
        wget \
        libgdal-dev \
        gdal-bin \
        libspatialindex-dev \
        unrar \
        && rm -rf /var/lib/apt/lists/*

    # Install Python packages
    pip install --no-cache-dir \
        mmcv-full==1.2.4 \
        mmdet==2.7.0 \
        gdal==3.2.0 \
        shapely==1.7.1 \
        earthengine-api \
        rasterio \
        geopandas

    # Install MMDetection
    cd /opt
    git clone https://github.com/open-mmlab/mmdetection.git
    cd mmdetection
    git checkout v2.7.0
    pip install -r requirements/build.txt
    pip install -v -e .

%environment
    export CUDA_HOME=/usr/local/cuda
    export PATH=/usr/local/cuda/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

%runscript
    exec python "$@"

%help
    Container for CPI detection with PyTorch 1.6.0, CUDA 10.1, and MMDetection v2.7.0

    Usage:
        singularity exec --nv cpi_detection.sif python batch_detect_africa.py
